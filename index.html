<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="images/Logomark.svg" />
    <title>L U X E</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/cart.css" />
    <link rel="stylesheet" href="css/signin.css" />
  </head>
  <body>
    <div id="discount" class="discount">
      <p>Get 25% OFF on your first order. Order Now</p>
    </div>
    <header>
      <div class="logo">
        <img src="images/Logomark.svg" alt="" />
        <h1>L U X E</h1>
      </div>
      <div class="links">
        <ul>
          <li class="na"><a href="#">Home</a></li>
          <li class="na"><a href="#">Collection</a></li>
          <li class="na"><a href="#">About</a></li>
          <li class="na"><a href="#">Contact</a></li>
        </ul>
      </div>
      <div class="right-header na">
        <img src="images/User.svg" alt="" />
      </div>
      <div class="split">
        <div class="hamburger-menu">
          <div class="hambar bar1"></div>
          <div class="hambar bar2"></div>
          <div class="hambar bar3"></div>
        </div>
      </div>
      <div class="off-screen-menu">
        <div class="logo">
          <img src="images/Logomark.svg" alt="" />
          <h1>L U X E</h1>
        </div>
        <ul class="Links2">
          <li class="nav na"><a href="#">Home</a></li>
          <li class="nav na"><a href="#">Collection</a></li>
          <li class="nav na"><a href="#">About</a></li>
          <li class="nav na"><a href="#">Contact</a></li>
        </ul>
        <div class="br nav na">
          <h4><a href="#">Cart</a></h4>
        </div>
        <div class="br nav na">
          <h4><a href="#">Profile</a></h4>
          <img src="images/User.svg" alt="" />
        </div>
      </div>
    </header>
    <section class="first-body-cart">
      <h1 id="form-title" class="fade2">Create Account</h1>
      <div class="signin fade1">
        <button id="google-btn">
          <img src="images/Google.svg" alt="" />
          <span>Continue with Google</span>
        </button>
        <div class="or-line">
          <div class="line"></div>
          <span>or</span>
          <div class="line"></div>
        </div>
        <form class="form" id="signup-form">
          <div>
            <label for="name">Name *</label>
            <input type="text" id="name" name="name" required />
          </div>
          <div>
            <label for="email">Email *</label>
            <input type="text" id="email" name="email" required />
          </div>
          <div>
            <label for="password">Password *</label>
            <input
              type="password"
              id="password"
              name="password"
              required
              autocomplete="on"
            />
          </div>
          <div id="password-container">
            <label for="confirmPassword">Confirm Password *</label>
            <input
              type="password"
              id="confirmPassword"
              name="passwordTwo"
              required
              autocomplete="on"
            />
          </div>
          <input type="submit" value="Register Now" id="button" />
        </form>
        <p>Already have an account? <a href="login.html">Sign In</a></p>
      </div>
    </section>
    <footer class="fade2">
      <div class="column1">
        <div class="bottom-logo">
          <img src="images/Logomark.svg" alt="" />
          <h1>Luxe Aisle</h1>
        </div>
        <h4>
          DevCut is a YouTube channel for <br />
          practical project-based learning.
        </h4>
        <div class="icons">
          <img src="images/Github.svg" alt="" />
          <img src="images/Vector.svg" alt="" />
          <img src="images/Youtube.svg" alt="" />
        </div>
      </div>
      <div class="column2">
        <h4>Support</h4>
        <h3>FAQ</h3>
        <h3>Terms of use</h3>
        <h3>Privacy Policy</h3>
      </div>
      <div class="column2">
        <h4>Company</h4>
        <h3>About us</h3>
        <h3>Contact</h3>
        <h3>Careers</h3>
      </div>
      <div class="column2">
        <h4>Shop</h4>
        <h3><a href="#discount">Collection</a></h3>
        <h3><a href="#discount">My Account</a></h3>
        <h3><a href="#discount">Cart</a></h3>
      </div>
      <div class="column3">
        <h2>Accepted Payments</h2>
        <div>
          <img src="images/Mastercard.svg" alt="" />
          <img src="images/Amex.svg" alt="" />
          <img src="images/Visa.svg" alt="" />
        </div>
      </div>
    </footer>
    <div class="copy-right">
      <hr />
      <p>&copy; 2024 BioCode. All rights reserved.</p>
    </div>

    <script src="app.js"></script>
    <script src="script.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
      import {
        createUserWithEmailAndPassword,
        getAuth,
        GoogleAuthProvider,
        signInWithPopup,
        EmailAuthProvider,
        linkWithCredential,
      } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

      import {
        getFirestore,
        collection,
        addDoc,
        where,
        query,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDYwTm46t-uDcw_721YefR81GNTVgQi_hI",
        authDomain: "luxe-aisle-ecommerce.firebaseapp.com",
        projectId: "luxe-aisle-ecommerce",
        storageBucket: "luxe-aisle-ecommerce.appspot.com",
        messagingSenderId: "102232001935",
        appId: "1:102232001935:web:f92a186dd496d3b96e8ffa",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const usersCollection = collection(db, "users");

      // Sign-up Form Submit Event
      const form = document.getElementById("signup-form");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = form.name.value;
        const email = form.email.value;
        const password = form.password.value;
        const confirmPassword = form.confirmPassword.value;
        const submitButton = document.getElementById("button");

        // Check if passwords match
        if (password !== confirmPassword) {
          Swal.fire({
            position: "top-end",
            icon: "error",
            title: "Passwords do not match",
            showConfirmButton: false,
            timer: 1500,
          });
          return;
        }

        try {
          submitButton.value = "Creating Account...";
          const userCredential = await createUserWithEmailAndPassword(
            auth,
            email,
            password
          );

          await addDoc(usersCollection, {
            name,
            email,
            uid: userCredential.user.uid,
          });

          const currentUser = await getloggedInUser(userCredential.user.uid);
          Swal.fire({
            position: "top-end",
            icon: "success",
            title: `Welcome, ${currentUser.name}`,
            showConfirmButton: false,
            timer: 1500,
          }).then(() => {
            window.location.href = "homepage.html";
            localStorage.removeItem("cart");
            const cartCount = document.getElementById("cart-count");
            const cartCountMobile = document.getElementById("cart-count2");
            if (cartCount) cartCount.textContent = 0;
            if (cartCountMobile) cartCountMobile.textContent = 0;
          });
        } catch (error) {
          Swal.fire({
            position: "top-end",
            icon: "error",
            title: "" + error.message,
            showConfirmButton: false,
            timer: 2500,
          });
        } finally {
          submitButton.value = "Register Now";
        }
      });

      // Block unauthorized access to certain features
      const navLinks = document.querySelectorAll(".na");
      navLinks.forEach((link) => {
        link.addEventListener("click", () => {
          Swal.fire({
            position: "top-end",
            icon: "info",
            title: "Sign in to access this feature",
            showConfirmButton: false,
            timer: 1500,
          });
        });
      });

      // Google Sign-in
      const googleButton = document.getElementById("google-btn");
      googleButton.addEventListener("click", async () => {
        const provider = new GoogleAuthProvider();
        try {
          const result = await signInWithPopup(auth, provider);
          const user = result.user;

          // Ask user to create a new password
          Swal.fire({
            title: "Create a password for your account",
            input: "password",
            inputLabel: "Password",
            inputPlaceholder: "Enter your password",
            inputAttributes: {
              maxlength: 20,
              autocapitalize: "off",
              autocorrect: "off",
            },
            showCancelButton: true,
          }).then(async (result) => {
            if (result.value) {
              const password = result.value;

              // Create EmailAuthProvider credential using Google email and new password
              const credential = EmailAuthProvider.credential(
                user.email,
                password
              );

              // Link the Google account with Email/Password account
              await linkWithCredential(user, credential);

              // Add user data to Firestore
              await addDoc(usersCollection, {
                name: user.displayName,
                email: user.email,
                uid: user.uid,
              });

              // Show success message and redirect
              Swal.fire({
                position: "top-end",
                icon: "success",
                title: `Welcome, ${user.displayName}`,
                showConfirmButton: false,
                timer: 1500,
              }).then(() => {
                window.location.href = "homepage.html";
              });
            }
          });
        } catch (error) {
          Swal.fire({
            position: "top-end",
            icon: "error",
            title: "Google sign-in failed: " + error.message,
            showConfirmButton: false,
            timer: 1500,
          });
        }
      });

      const getloggedInUser = async (id) => {
        try {
          const q = query(usersCollection, where("uid", "==", id));
          const querySnapshot = await getDocs(q);

          if (!querySnapshot.empty) {
            const user = querySnapshot.docs[0].data();
            console.log("User found: ", user);
            return user;
          } else {
            console.log("No user found");
            return null;
          }
        } catch (error) {
          console.error(error);
        }
      };
    </script>
  </body>
</html>
